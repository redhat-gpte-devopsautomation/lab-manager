---

- import_playbook: "{{ collections_dir }}/common/playbooks/env-finder.yml"
  vars:
    collections_dir: "./collections/ansible_collections/manager"


- import_playbook: "{{ collections_dir }}/common/playbooks/instance-provisioner.yml"
  vars:
    collections_dir: "./collections/ansible_collections/manager"
  when:
    - 'not env_destroy | default(false) | bool'
    - 'not only_config |default(false) |bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'


# - import_playbook: "./defaults/playbooks/instance-config.yml"
#   when:
#     - 'not env_destroy | default(false) | bool' 
#     - 'instance_configure | default(true) | bool'
#     - 'env_name is defined'
#     - 'provisioner == "instances"'

- import_playbook: "{{ lab_mgr_dir }}/common/playbooks/instance-destroy.yml"
  vars:
    collections_dir: "./collections/ansible_collections/manager"
  when: 
    - 'env_destroy | default(false) | bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'

# - name: Import bind9 pod update playbook
#   import_playbook: ./environments/pods/bind9/config.yml
#   when:
#     - 'not only_config |default(false) |bool'
#     - 'env_name is defined'
#     - 'provisioner == "instances"'

# # Pod provisioner and destroyer
# - name: Import config/provision playbook from environment
#   vars:
#     find_config:
#       - ./environments/{{ provisioner }}/{{ env_name }}/provisioner.yml
#       - ./defaults/playbooks/pod-provisioner.yml
#   import_playbook: "{{ lookup('first_found', find_config) }}"
#   when: 
#     - 'not env_destroy | default(false) | bool'
#     - 'not only_config |default(false) |bool'
#     - 'env_name is defined'
#     - provisioner == 'pods'

# - name: Import destroy playbook from environment
#   vars:
#     find_destroy:
#       - ./environments/{{ provisioner }}/{{ env_name }}/destroy.yml
#       - ./defaults/playbooks/pod-destroy.yml
#   import_playbook: "{{ lookup('first_found', find_destroy) }}"
#   when:
#     - 'env_destroy | default(false) | bool'
#     - 'not only_config |default(false) |bool'
#     - 'env_name is defined'
#     - provisioner == 'pods'
    
# - name: Pod Reconfigure / workload
#   vars:
#     find_update:
#       - ./environments/{{ provisioner }}/{{ env_name }}/config.yml
#       - ./defaults/playbooks/pod_config_none.yml
#   import_playbook: "{{ lookup('first_found', find_update) }}"
#   when:
#     - 'not env_destroy | default(false) | bool'
#     - 'only_config |default(false) |bool'
#     - 'env_name is defined'
#     - provisioner == 'pods'

# - name: Import haproxy pod update playbook
#   import_playbook: ./environments/pods/haproxy/config.yml
#   when:
#     - 'not only_config |default(false) |bool'
#     - 'env_name != "haproxy"'
#     - 'provisioner is defined'

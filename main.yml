---

- import_playbook: "{{ collections_dir }}/manager/common/playbooks/env-finder.yml"
  vars:
    collections_dir: "./collections/ansible_collections/"


- import_playbook: "{{ collections_dir }}/manager/common/playbooks/instance-provisioner.yml"
  vars:
    collections_dir: "./collections/ansible_collections/"
  when:
    - 'not env_destroy | default(false) | bool'
    - 'not only_config |default(false) |bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'


- import_playbook: "{{ collections_dir }}/manager/common/playbooks/instance-config.yml"
  vars:
    collections_dir: "./collections/ansible_collections/"
  when:
    - 'not env_destroy | default(false) | bool' 
    - 'instance_configure | default(true) | bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'

- import_playbook: "{{ collections_dir }}/manager/common/playbooks/instance-destroy.yml"
  vars:
    collections_dir: "./collections/ansible_collections/"
  when: 
    - 'env_destroy | default(false) | bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'

- name: Import bind9 pod update playbook
  import_playbook: "{{ lab_mgr_dir }}/environments/pods/bind9/config.yml"
  when:
    - 'not only_config |default(false) |bool'
    - 'env_name is defined'
    - 'provisioner == "instances"'

# Pod provisioner and destroyer
- name: Provision Pods
  vars:
    collections_dir: "./collections/ansible_collections/"
    find_config:
      - "{{ lab_mgr_dir }}/environments/{{ provisioner }}/{{ env_name }}/provisioner.yml"
      - "{{ collections_dir }}/manager/common/playbooks/pod-provisioner.yml"
  import_playbook: "{{ lookup('first_found', find_config) }}"
  when: 
    - 'not env_destroy | default(false) | bool'
    - 'not only_config | default(false) |bool'
    - 'env_name is defined'
    - 'provisioner == "pods"'

- name: Destroy Pods
  vars:
    collections_dir: "./collections/ansible_collections/"
    find_destroy:
      - "{{ lab_mgr_dir }}/environments/{{ provisioner }}/{{ env_name }}/destroy.yml"
      - "{{ collections_dir }}/manager/common/playbooks/pod-destroy.yml"
  import_playbook: "{{ lookup('first_found', find_destroy) }}"
  when:
    - 'env_destroy | default(false) | bool'
    - 'env_name is defined'
    - 'provisioner == "pods"'
    
- name: Pod Reconfigure / workload
  vars:
    collections_dir: "./collections/ansible_collections/"
    find_update:
      - "{{ lab_mgr_dir }}/environments/{{ provisioner }}/{{ env_name }}/config.yml"
      - "{{ collections_dir }}/manager/common/playbooks/pod_config_none.yml"
  import_playbook: "{{ lookup('first_found', find_update) }}"
  when:
    - 'not env_destroy | default(false) | bool'
    - 'only_config |default(false) |bool'
    - 'env_name is defined'
    - 'provisioner == "pods"'

- name: Import haproxy pod update playbook
  import_playbook: "{{ lab_mgr_dir }}/environments/pods/haproxy/config.yml"
  when:
    - 'not only_config |default(false) |bool'
    - 'env_name != "haproxy"'
    - 'provisioner is defined'

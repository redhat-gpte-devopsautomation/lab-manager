---

- import_playbook: "./defaults/playbooks/instance-provisioner.yml"
  when: 
    - 'provisioner == "instances"'
    - not env_destroy | default(false) | bool 

- import_playbook: "./defaults/playbooks/instance-config.yml"
  when:
    - 'provisioner == "instances"'
    - instance_configure | default(true) | bool
    - not env_destroy | default(false) | bool  

- import_playbook: "./defaults/playbooks/instance-destroy.yml"
  when: 
    - 'provisioner == "instances"'
    - env_destroy | default(false) | bool

# Pod provisioner and destroyer
- name: Import config/provision playbook from environment
  vars:
    find_config:
      - ./environments/{{ provisioner }}/{{ env_type }}/config.yml
      - ./defaults/playbooks/pod-provisioner.yml
  import_playbook: "{{ lookup('first_found', find_config) }}"
  when: 
    - not env_destroy | default(false) | bool
    - provisioner == 'pods'

- name: Import destroy playbook from environment
  vars:
    find_destroy:
      - ./environments/{{ provisioner }}/{{ env_type }}/destroy.yml
      - ./defaults/playbooks/pod-destroy.yml
  import_playbook: "{{ lookup('first_found', find_destroy) }}"
  when: 
    - env_destroy | default(false) | bool
    - provisioner == 'pods'
    
- name: Re-configure Haproxy pod
  import_playbook: ./defaults/playbooks/pod-reconfig-haproxy.yml
  when:
    - provisioner != 'pods'
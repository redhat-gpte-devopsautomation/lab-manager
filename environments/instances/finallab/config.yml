---

- name: tower setup
  hosts: localhost
  connection: localhost
  gather_facts: false
  tasks:
    # - name: Include variables
    #   include_tasks: ./defaults/tasks/include_vars.yml
      
    - name: Download Tower Setup file
      unarchive:
        src: "https://releases.ansible.com/ansible-tower/setup/ansible-tower-setup-{{tower_version}}.tar.gz"
        dest: /tmp/
        remote_src: yes 

    - name: Remove directory if it exists
      file:
        path: /tmp/ansible-tower-setup-latest
        state: absent

    - name: Rename the ansible tower setup directory name
      shell: mv /tmp/ansible-tower-setup-* /tmp/ansible-tower-setup-latest

    - name: Run Ansible Tower setup
      shell: ./setup.sh -i {{ lab_mgr_dir }}/environments/{{ provisioner }}/{{ env_type }}/inventory
      args:
        chdir: /tmp/ansible-tower-setup-latest
      async: 3600
      poll: 36